---
title: "Project Report"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide

---

## Motivation
Since the beginning of the 20th century, coffee has transcended national boundaries and catered to the tastes of diverse groups of people. As a group of coffee lovers, we are well-realized about how important a good cup of coffee can be for a fulfilling day. Therefore, we wish to analyze the quality of coffee from two aspects -- the objective geographical factors and subjective costumer preferences.

## Data Source

### Ratings Data

The project utilizes the data from the [Coffee Quality Institute](https://database.coffeeinstitute.org/) (the original data can be found on [James LeDoux's github](https://github.com/jldbc/coffee-quality-database)) to rate coffee based on their acidity, sweetness, aroma, altitude, and region, offering a comprehensive look at coffee. By incorporating data on the ["Great American Coffee Taste Test"](https://www.youtube.com/watch?v=bMOOQfeloH0), our project also explores how consumer tastes align with professional ratings. This combination of objective and public data can provide insights into how coffee qualities influence consumer preferences, helping producers, coffee shops, and consumers make their favorite choices.

To make it easier to analyze the data, we named the coffee quality ratings dataset `ratings_df`. There are many variables in this dataset, and after careful consideration in relation to our project questions, we have selected the following variables for this project:

* `total_cup_points`: Total rating/points (0 - 100 scale)

* `species`: Species of coffee bean (arabica or robusta)

* `country_of_origin`: Where the bean came from

* `variety`: Variety of the beans

* `grading_date`: When the beans were graded

* `processing_method`: Method for processing

* `aroma`: Aroma grade

* `flavor`: Flavor grade

* `aftertaste`: Aftertaste grade

* `acidity`: Acidity grade

* `body`: Body grade

* `balance`: Balance grade

* `sweetness`: Sweetness grade

* `altitude_mean_meters`: Altitude mean meters

### Survey Data

In October 2023, "world champion barista" James Hoffmann and coffee company Cometeer held the [“Great American Coffee Taste Test”](https://www.youtube.com/watch?v=bMOOQfeloH0) across the United States, during which viewers were asked to fill out a survey about their demographic information, coffee-related preferences and lifestyle, as well as their tasting experience of 4 cups of coffee ordered from Cometeer. The data is available at [GitHub](https://github.com/rfordatascience/tidytuesday/tree/master/data/2024/2024-05-14), cleaned by TidyTuesday. 

**Data Dictionary**


*Demographic Information*

* `submission_id`: Participant's submission ID

* `age`: Participant's age

* `gender`: Participant's gender

* `education_level`: Participant's education level

* `ethnicity_race`: Participant's ethnicity/race

* `employment_status`: Participant's employment status

* `wfh`: Do you work from home or in person?


*Coffee-related Preferences and Lifestyle*

* `cups`: How many cups of coffee do you typically drink per day?

* `where_drink`: Where do you typically drink coffee?

* `why_drink`: Why do you drink coffee?

* `brew`: How do you brew coffee at home?

* `purchase`: On the go, where do you typically purchase coffee?

* `favorite`: What is your favorite coffee drink?

* `additions`: Do you usually add anything to your coffee?

* `dairy`: What kind of dairy do you add?

* `sweetener`: What kind of sugar or sweetener do you add?

* `style`: Before today's tasting, which of the following best described what kind of coffee you like?

* `strength`: How strong do you like your coffee?

* `roast_level`: What roast level of coffee do you prefer?

* `caffeine`: How much caffeine do you like in your coffee?

* `expertise`: How would you rate your own coffee expertise?

* `total_spend`: In total, much money do you typically spend on coffee in a month?

* `taste`: Do you like the taste of coffee?

* `most_paid`: What is the most you've ever paid for a cup of coffee?

* `most_willing`: What is the most you'd ever be willing to pay for a cup of coffee?


*Tasting Experience of 4 Cups of Coffee Ordered*

* `coffee_name`: Name of the ordered coffee (A, B, C, D)

* `bitterness`: Bitterness rating

* `acidity`: Acidity rating

* `preference`: Personal preference rating

* `prefer_ad`: Prefer coffee A or D

* `prefer_overall`: Favorite overall coffee among 4 cups



## Initial Questions

We hope to obtain a comprehensive view on both the objective factors that influence the taste of the coffee (e.g. species, altitude) and how features of different populations affect their subjective preferences for coffee (e.g. gender, education level). 

Some possible questions include:

- How much people would pay for a cup of coffee based on their quality?

- Does the public taste of coffee accord with the "official" level of certification?

- What are the countries with high coffee ratings in general?

- The relationship between altitude and coffee characteristics.

## Data Cleaning

### Ratings Data

For the ratings data, we first filtered out the variables needed for our project analysis then removed the unnecessary ones. We created a new column named `grading_year` by extracting the year as a four-digit number from the grading_date column using the `str_extract` function. This isolates the year, because we want to analyze the coffee ratings based on the year instead of focusing on a specific month and date. Additionally, the `species`, `variety`, and `processing_method` columns are converted into factors using the `as.factor` function. This step ensures that these variables are treated as categorical variables, making them suitable for our later statistical analysis. 



## Exploratory Analysis

### Ratings Data

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(modelr)
library(plotly)
library(forcats)
library(corrplot)
library(glmnet)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%",
  warning = FALSE,
  message = FALSE
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


```{r}
ratings_df = read_csv("data/coffee_ratings.csv") %>% 
  janitor::clean_names() %>%
  select(total_cup_points, species, country_of_origin, 
         region, number_of_bags, bag_weight, grading_date, variety,
         processing_method, aroma, flavor, aftertaste, acidity, body, balance,
         sweetness,altitude_mean_meters) %>%
  mutate(grading_year = str_extract(grading_date, "\\d{4}"),
         species = as.factor(species),
         variety = as.factor(variety),
         processing_method = as.factor(processing_method))
```



```{r}
Q1_tcup = quantile(ratings_df$total_cup_points, 0.25, na.rm = TRUE)
Q3_tcup = quantile(ratings_df$total_cup_points, 0.75, na.rm = TRUE)
IQR_tcup = Q3_tcup - Q1_tcup

lower_bound_tcup = Q1_tcup - 1.5 * IQR_tcup
upper_bound_tcup = Q3_tcup + 1.5 * IQR_tcup

Q1_alt = quantile(ratings_df$altitude_mean_meters, 0.25, na.rm = TRUE)
Q3_alt = quantile(ratings_df$altitude_mean_meters, 0.75, na.rm = TRUE)
IQR_alt = Q3_alt - Q1_alt

lower_bound_alt = Q1_alt - 1.5 * IQR_alt
upper_bound_alt = Q3_alt + 1.5 * IQR_alt

ratings_no_outliers = ratings_df %>%
  filter(
    total_cup_points >= lower_bound_tcup & total_cup_points <= upper_bound_tcup,
    altitude_mean_meters >= lower_bound_alt & altitude_mean_meters <= upper_bound_alt
  )
```


#### The Distribution of the Total Cup Points

```{r}
points_dis = ggplot(ratings_df, aes(x = total_cup_points)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  coord_cartesian(xlim = c(60, NA)) +
  theme_minimal() +
  labs(title = "Total Cup Points Distribution", x = "Total Cup Points", y = "Frequency")

ggplotly(points_dis)
```


Firstly, we accumulate the frequency of the total cup points. The distribution of total cup points is bell-shaped and similar to the normal distribution. The most frequent total cup points is 83, and most coffee beans are in the 80 to 85 cup points range.



#### Trend of Average Total Cup Points Over Years

```{r}
ratings_df |> 
  group_by(grading_year) |> 
  summarise(avg_total_cup_points = mean(total_cup_points, na.rm = TRUE)) |> 
  plot_ly(x = ~ grading_year, y = ~ avg_total_cup_points, type = "scatter", 
          mode = "lines + markers") |> 
  layout(title = "Trend of Average Total Cup Points Over Years",
         xaxis = list(title = "Year"),
         yaxis = list(title = "Average Total Cup Points"))
```


We examine trends over the 8-year time period to get insights into how coffee quality has fluctuated. The plot shows a non-linear trend of average cup points across eight years. The years 2010 and 2018 exhibited the highest average scores, while 2012 and 2017 saw significant dips. The variability in cup points across years indicates that coffee quality is not static and can fluctuate significantly, warranting a deeper investigation into contributing factors.


#### The Distribution of Varieties by Species


```{r}
variety_dis = ratings_df %>%
  filter(!is.na(variety)) %>%
  ggplot(aes(x = fct_rev(fct_infreq(variety)))) +
  geom_bar(fill = "skyblue") +
  facet_grid(~ species, scales = "free_x") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.5, size = 8),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Frequency of Varieties by Species",
    x = "Variety",
    y = "Count"
  )


ggplotly(variety_dis)
```


Then, we distribute the species and variety composition of the sample coffee beans. Almost all coffee beans belong to the Arabica species, and among the Arabica, Caturra, Bourbon, and Typica are the most abundant, while Sumatra Lintong, Sulawesi, Pache Comun, and Moka Peaberry are the least.  


#### Distribution of Total Cup Points by Species

```{r}
Q1 <- quantile(ratings_df$total_cup_points, 0.25)
Q3 <- quantile(ratings_df$total_cup_points, 0.75)
IQR <- Q3 - Q1
ratings_df <- ratings_df %>%
  filter(total_cup_points > (Q1 - 1.5 * IQR) & total_cup_points < (Q3 + 1.5 * IQR))

ratings_df |> 
  filter(!is.na(total_cup_points)) |> 
  plot_ly(x = ~ species, y = ~ total_cup_points, type = "box", color = ~species) |> 
   layout(title = "Boxplot of Total Cup Points by Species",
         xaxis = list(title = "Species"),
         yaxis = list(title = "Total Cup Points"))
```

We removed outliers by using the interquartile range (IQR) method to identify and filter extreme values. After removing outliers, the boxplot shows a more compact and representative distribution for both Arabica and Robusta species. The general trends remain the same, with Arabica having a slightly higher median and a wider data range than Robusta.


#### The Boxplot of Variety and Total Cup Points


```{r}
ratings_no_outliers |> 
  mutate(variety = fct_reorder(variety, total_cup_points)) |> 
  plot_ly(
    y = ~total_cup_points, 
    color = ~variety, 
    type = "box", 
    colors = "viridis"
  ) %>%
  layout(
    yaxis = list(
      title = "Total Cup Points",
      range = c(50, NA) 
    ),
    xaxis = list(
      title = "Variety"
    ))
```


We also produce the boxplot of total cup points by varieties. Through this boxplot, we know that Sumatra Lintong and Sumatra tend to perform better than the others on the total cup points, while Pache Comun and Java perform the worst. It is worth mentioning that the IQR of the total cup points of Java is the largest, which means the total cup points of Java have high variability and are more spread out around the median.


#### Proportion of Processing Methods

```{r}
ratings_df |> 
  count(processing_method) |> 
  mutate(prop = n / sum(n)) |> 
  plot_ly(
    x = ~ prop,
    y = ~ reorder(processing_method, prop),
    type = "bar",
    marker = list(fill = ~ processing_method)
  ) |> 
  layout(
    title = "Proportion of Processing Methods",
    xaxis = list(title = "Proportion"),
    yaxis = list(title = "Processing Method")
  )
```

Washed/Wet processing dominates (around 60%), followed by Natural/Dry methods. Other processing methods such as Semi-washed, Pulped Natural/Honey are less common. This highlights the dominance of Washed/Wet processing methods. However, alternative methods like Natural/Dry still hold a significant share, prompting further investigation into how processing affects scores.

#### Total Cup Points by Processing Methods

```{r}
without_outliers = ratings_df |> 
  drop_na(total_cup_points, processing_method)  |> 
  group_by(processing_method)  |> 
  mutate(
    Q1 = quantile(total_cup_points, 0.25),
    Q3 = quantile(total_cup_points, 0.75),
    IQR = Q3 - Q1,
    lower_bound = Q1 - 1.5 * IQR,
    upper_bound = Q3 + 1.5 * IQR
  )  |> 
  filter(total_cup_points >= lower_bound & total_cup_points <= upper_bound)

without_outliers |> 
  plot_ly(
    x = ~ total_cup_points,
    y = ~ reorder(processing_method, total_cup_points, median),
    type = "box",
    color = ~ processing_method
  )  |> 
  layout(
    title = "Total Cup Points by Processing Methods",
    xaxis = list(title = "Total Cup Points"),
    yaxis = list(title = "Processing Method")
  )
```

This comparison evaluates how different processing methods impact total cup points. The Natural/Dry processing method tends to yield the highest median and total cup points, suggesting its potential for producing higher-quality coffee. The Pulped Natural/Honey and Semi-washed/Semi-pulped methods have narrower distributions, indicating less variability in cup points. The Washed/Wet method is also consistent, with a median similar to Semi-washed but a slightly broader spread. 



#### The Distribution between Total Cup Points and Altitude by Variety



```{r}
altitude_model = lm(altitude_mean_meters ~ total_cup_points, data = ratings_no_outliers)

x_vals = seq(min(ratings_no_outliers$total_cup_points, na.rm = TRUE), 
              max(ratings_no_outliers$total_cup_points, na.rm = TRUE), length.out = 100)
y_preds = predict(altitude_model, newdata = data.frame(total_cup_points = x_vals))
```



```{r, warning=FALSE, message=FALSE}
ratings_no_outliers |>
  filter(!is.na(total_cup_points) & !is.na(altitude_mean_meters)) |>
  mutate(text_label = str_c("Total Cup Points: ", total_cup_points, 
                       "\nMean Altitude(meters): ", altitude_mean_meters,
                       "\nVariety: ", variety)) |>
  plot_ly(x = ~total_cup_points,
  y = ~altitude_mean_meters,
  type = "scatter",
  mode = "markers",
  color = ~variety,
  text = ~text_label,
  alpha = 0.5
) %>%
  add_lines(
    x = x_vals,
    y = y_preds,
    line = list(color = 'red'),
    name = 'Trend Line',
    showlegend = FALSE,
    inherit = FALSE
  ) %>%
  layout(
    title = "Total Cup Points vs. Mean Altitude (meters)",
    xaxis = list(title = "Total Cup Points",
      range = c(60, max(ratings_no_outliers$total_cup_points, na.rm = TRUE))),
    yaxis = list(title = "Altitude Mean Meters")
  )

```



This plot shows the distribution between the mean altitude of the coffee beans and the total cup points. Although there is no obvious trend if we only look at the scatter on the plot, we can see that there is a positive correlation between mean altitude and total cup points by looking at the increasing trend lines. As the altitude goes up, the total cup points of the coffee bean increases.





#### Origins of Top Coffees Each Year

```{r}
top_origins_yearly = 
  ratings_df |> 
  drop_na(variety) |> 
  group_by(grading_year) |> 
  arrange(grading_year, desc(total_cup_points)) |> 
  slice(1)

top_origins_yearly |> 
  arrange(grading_year) |> 
  select(grading_year, country_of_origin, total_cup_points, species, variety) |> 
  knitr::kable(
    col.names = c("Year", "Country of Origin", "Total Cup Points", 
                  "Species", "Variety"),
    caption = "Top Coffee by Country from 2010 to 2018",
  )
```

We are curious about the top coffee origins and want to see if there exists regional strengths or cultivation efforts. Therefore we make a table showing that top-performing coffees come from a diverse set of countries, with no single country dominating year after year. Ethiopia appears twice, with exceptionally high scores in 2015. 

## Statistical Analysis

### Ratings Data

#### Correlation Test


```{r}
features <- c("aroma", "flavor", "aftertaste", "acidity", "body", "balance", "sweetness")
target <- "total_cup_points"
```

We choose the variables associated with the sensory, which are `aroma`, `flavor`, `aftertaste`, `acidity`, `body`, `balance`, and `sweetness`, as the predictor variables of the model, and the `total_cup_points` as the response variable.

```{r}
corr_matrix = cor(ratings_df[, c(features, target)], use = "complete.obs")
corrplot(corr_matrix, method = "number", type = "upper", tl.cex = 0.8)
```

To check the effectiveness of the variables, if these variables affect the total cup points, we perform the correlation test between these variables before building the model. A larger coefficient indicates a stronger correlation. There are high correlations between almost all independent variables and the dependent variable. Although the correlation between `sweetness` and `total_cup_points` is the lowest, the correlation is not weak, so we will use all these predictors to build the model. Since there are so many predictors, we will choose to make a lasso model.

#### Lasso Model

```{r}
x = as.matrix(ratings_df[, features])
y = ratings_df |> pull(total_cup_points)
```



```{r}
lambda = 10^(seq(-2, 2.75, 0.1))

lasso_fit =
  glmnet(x, y, lambda = lambda)

lasso_cv =
  cv.glmnet(x, y, lambda = lambda)

lambda_opt = lasso_cv[["lambda.min"]]
```

Generating a sequence of lambda values to create a range of lambda values on a logarithmic scale to ensure our proper exploration of the regularization strength.




```{r}
lasso_cv |> 
  broom::tidy() |> 
  ggplot(aes(x = log(lambda, 10), y = estimate)) + 
  geom_point()
```

This plot visualizes the effect of different lambda values on the estimated coefficients.

At smaller values of log(lambda, 10), the estimated coefficients are smaller or close to zero.As log(lambda, 10) increases, the coefficients stabilize and converge toward specific values.

```{r}
lasso_fit = glmnet(x, y, lambda = lambda_opt)

lasso_fit |> broom::tidy() |> 
  knitr::kable()
```

The intercept value is 5.08, which represents the baseline predicted value of `total_cup_points` when all predictors are zero.

All predictors (`aroma`, `flavor`, `aftertaste`, `acidity`, `body`, `balance`, `sweetness`) have non-zero coefficients, indicating they contribute to the model at the optimal lambda.

`flavor` has the largest coefficient with the value of 1.97, suggesting that flavor is the most influential predictor in determining the total cup points.

`body`(0.579) and `acidity`(0.895) have relatively the smallest coefficients, indicating that they have a weaker influence on the total cup points compared to others variables.

The deviance ratio is 0.923, suggesting that the model explains a significant portion of the variability in `total_cup_points.`

#### ANOVA

```{r}
ratings_no_outliers = ratings_df |>
  drop_na(processing_method)

anova_method = aov(total_cup_points ~ processing_method, data = ratings_no_outliers)
summary(anova_method)
```


The results of the one-way ANOVA test, as displayed in the output, assess whether there is a significant difference in total cup points among different processing methods in the dataset. The F-statistic value is 1.978 with a p-value of 0.0956. Since the p-value is greater than the typical significance level of 0.05, we fail to reject the null hypothesis. This suggests that there is no statistically significant difference in the total cup points across the processing methods at the 5% significance level. 

#### T Test


```{r}
pairwise.t.test(ratings_no_outliers$total_cup_points, ratings_no_outliers$processing_method, 
                                    p.adjust.method = "bonferroni")
```

The results of the pairwise t-tests, adjusted using the Bonferroni method for multiple comparisons, reveal no statistically significant differences in total cup points between any pairs of processing methods. All adjusted p-values are greater than 0.05. This suggests that the mean total cup points are comparable across the different processing methods analyzed (e.g., Natural/Dry, Other, Pulped Natural/Honey, Semi-Washed/Semi-Pulped, and Washed/Wet). The lack of significant differences aligns with the earlier ANOVA results, indicating that the processing method does not have a substantial impact on total cup points when considering the current dataset.


## Discussion

* **Trend Over Years:** The trend of average total cup points across eight years reveals significant fluctuations, indicating variability in coffee quality over time. Peaks in 2010 and 2018 demonstrate years of higher overall quality, while dips, such as those in 2012 and 2017, suggest more analysis based on factors potentially affecting quality. These trends underscore the need for further investigation into external influences that impact yearly coffee quality, such as market selection, climate change, and agricultural practices.

* **Species Comparison:** Arabica coffee consistently achieves a higher median and a narrower interquartile range compared to Robusta. This finding aligns with the general perception of Arabica as a higher-quality coffee species. In contrast, Robusta exhibits greater variability in quality, which may reflect diverse cultivation practices or broader market applications.

* **Processing Methods:** The dominance of Washed/Wet processing, accounting for 60% of the dataset, reflects its widespread adoption in the coffee industry. However, the presence of other methods, such as Natural/Dry and Semi-Washed/Semi-Pulped, suggests regional or market-specific preferences. Interestingly, the boxplot comparison indicates that Natural/Dry processing yields the highest median cup points, suggesting its potential for producing high-quality coffee. The variability across methods suggests opportunities for further research into how processing techniques affect sensory attributes.

* **Coffee Origins:** An examination of top coffees by year highlights diverse geographic contributions. The recurrence of Ethiopia suggests a possible regional influence and established reputation in the specialty coffee market. The diversity of origins underscores the global nature of high-quality coffee production and the importance of local growing conditions.

* **Predictive Modeling:** The regression analysis identifies flavor as the most influential factor driving total cup points, followed by aftertaste and balance. These sensory attributes are critical in defining coffee quality and consumer preferences. The relatively smaller coefficients for body and acidity suggest they have less impact in this model but remain integral components of coffee evaluation.

* **Statistical Testing:** The ANOVA and t-test results both reveal no statistically significant differences in total cup points across processing methods, suggesting that the method of processing alone does not substantially affect coffee quality. 




## Limitations

* Since Arabica coffee account for a large proportion of species in our dataset, we cannot tell the objective difference in coffee performance between the two coffee species. The data for a species with a uniform distribution will provide more information for the relevant analysis.

* The ratings data spans eight years, but it does not account for external variables like climate changes, global market dynamics, or agricultural practices that could influence coffee quality. These factors could have contributed to the observed fluctuations but were not explicitly analyzed.





