---
title: "Project Report"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

## Motivation
Since the beginning of the 20th century, coffee has transcended national boundaries and catered to the tastes of diverse groups of people. As a group of coffee lovers, we are well-realized about how important a good cup of coffee can be for a fulfilling day. Therefore, we wish to analyze the quality of coffee from two aspects -- the objective geographical factors and subjective costumer preferences.

## Data Source

### Ratings Data

The project utilizes the data from the [Coffee Quality Institute](https://database.coffeeinstitute.org/) (the original data can be found on [James LeDoux's github](https://github.com/jldbc/coffee-quality-database)) to rate coffee based on their acidity, sweetness, aroma, altitude, and region, offering a comprehensive look at coffee. By incorporating data on the ["Great American Coffee Taste Test"](https://www.youtube.com/watch?v=bMOOQfeloH0), our project also explores how consumer tastes align with professional ratings. This combination of objective and public data can provide insights into how coffee qualities influence consumer preferences, helping producers, coffee shops, and consumers make their favorite choices.

To make it easier to analyze the data, we named the coffee quality ratings dataset `ratings_df`. There are many variables in this dataset, and after careful consideration in relation to our project questions, we have selected the following variables for this project:

* `total_cup_points`: Total rating/points (0 - 100 scale)

* `species`: Species of coffee bean (arabica or robusta)

* `country_of_origin`: Where the bean came from

* `variety`: Variety of the beans

* `grading_date`: When the beans were graded

* `processing_method`: Method for processing

* `aroma`: Aroma grade

* `flavor`: Flavor grade

* `aftertaste`: Aftertaste grade

* `acidity`: Acidity grade

* `body`: Body grade

* `balance`: Balance grade

* `sweetness`: Sweetness grade

* `altitude_mean_meters`: Altitude mean meters

### Survey Data

In October 2023, "world champion barista" James Hoffmann and coffee company Cometeer held the [“Great American Coffee Taste Test”](https://www.youtube.com/watch?v=bMOOQfeloH0) across the United States, during which viewers were asked to fill out a survey about their demographic information, coffee-related preferences and lifestyle, as well as their tasting experience of 4 cups of coffee ordered from Cometeer. The data is available at [GitHub](https://github.com/rfordatascience/tidytuesday/tree/master/data/2024/2024-05-14), cleaned by TidyTuesday. 

**Data Dictionary**


*Demographic Information*

* `submission_id`: Participant's submission ID

* `age`: Participant's age

* `gender`: Participant's gender

* `education_level`: Participant's education level

* `ethnicity_race`: Participant's ethnicity/race

* `employment_status`: Participant's employment status

* `wfh`: Do you work from home or in person?


*Coffee-related Preferences and Lifestyle*

* `cups`: How many cups of coffee do you typically drink per day?

* `where_drink`: Where do you typically drink coffee?

* `why_drink`: Why do you drink coffee?

* `brew`: How do you brew coffee at home?

* `purchase`: On the go, where do you typically purchase coffee?

* `favorite`: What is your favorite coffee drink?

* `additions`: Do you usually add anything to your coffee?

* `dairy`: What kind of dairy do you add?

* `sweetener`: What kind of sugar or sweetener do you add?

* `style`: Before today's tasting, which of the following best described what kind of coffee you like?

* `strength`: How strong do you like your coffee?

* `roast_level`: What roast level of coffee do you prefer?

* `caffeine`: How much caffeine do you like in your coffee?

* `expertise`: How would you rate your own coffee expertise?

* `total_spend`: In total, much money do you typically spend on coffee in a month?

* `taste`: Do you like the taste of coffee?

* `most_paid`: What is the most you've ever paid for a cup of coffee?

* `most_willing`: What is the most you'd ever be willing to pay for a cup of coffee?


*Tasting Experience of 4 Cups of Coffee Ordered*

* `coffee_name`: Name of the ordered coffee (A, B, C, D)

* `bitterness`: Bitterness rating

* `acidity`: Acidity rating

* `preference`: Personal preference rating

* `prefer_ad`: Prefer coffee A or D

* `prefer_overall`: Favorite overall coffee among 4 cups



## Initial Questions

We hope to obtain a comprehensive view on both the objective factors that influence the taste of the coffee (e.g. species, altitude) and how features of different populations affect their subjective preferences for coffee (e.g. gender, education level). 

Some possible questions include:

- How much people would pay for a cup of coffee based on their quality?

- Does the public taste of coffee accord with the "official" level of certification?

- What are the countries with high coffee ratings in general?

- The relationship between altitude and coffee characteristics.

## Data Cleaning

### Ratings Data

For the ratings data, we first filtered out the variables needed for our project analysis then removed the unnecessary ones. We created a new column named `grading_year` by extracting the year as a four-digit number from the grading_date column using the `str_extract` function. This isolates the year, because we want to analyze the coffee ratings based on the year instead of focusing on a specific month and date. Additionally, the `species`, `variety`, and `processing_method` columns are converted into factors using the `as.factor` function. This step ensures that these variables are treated as categorical variables, making them suitable for our later statistical analysis. 

For the surveys data, to make the analysis of the ratings for Coffee A, B, C, and D easier, we first used pivot long to turn coffee names, features, and respective scores into different variables. Then, we pivoted the dataset wider to make the features individual variables with the scores as their values. All categorical variables are mutated into factor variables, and we selected only useful variables for the analysis from the dataset. 

## Exploratory Analysis

### Ratings Data

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(modelr)
library(plotly)
library(forcats)
library(corrplot)
library(glmnet)
library(leaps)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%",
  warning = FALSE,
  message = FALSE
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


```{r}
ratings_df = read_csv("data/coffee_ratings.csv") %>% 
  janitor::clean_names() %>%
  select(total_cup_points, species, country_of_origin, 
         region, number_of_bags, bag_weight, grading_date, variety,
         processing_method, aroma, flavor, aftertaste, acidity, body, balance,
         sweetness,altitude_mean_meters) %>%
  mutate(grading_year = str_extract(grading_date, "\\d{4}"),
         species = as.factor(species),
         variety = as.factor(variety),
         processing_method = as.factor(processing_method))
```



```{r}
Q1_tcup = quantile(ratings_df$total_cup_points, 0.25, na.rm = TRUE)
Q3_tcup = quantile(ratings_df$total_cup_points, 0.75, na.rm = TRUE)
IQR_tcup = Q3_tcup - Q1_tcup

lower_bound_tcup = Q1_tcup - 1.5 * IQR_tcup
upper_bound_tcup = Q3_tcup + 1.5 * IQR_tcup

Q1_alt = quantile(ratings_df$altitude_mean_meters, 0.25, na.rm = TRUE)
Q3_alt = quantile(ratings_df$altitude_mean_meters, 0.75, na.rm = TRUE)
IQR_alt = Q3_alt - Q1_alt

lower_bound_alt = Q1_alt - 1.5 * IQR_alt
upper_bound_alt = Q3_alt + 1.5 * IQR_alt

ratings_no_outliers = ratings_df %>%
  filter(
    total_cup_points >= lower_bound_tcup & total_cup_points <= upper_bound_tcup,
    altitude_mean_meters >= lower_bound_alt & altitude_mean_meters <= upper_bound_alt
  )
```


#### The Distribution of the Total Cup Points

```{r}
points_dis = ggplot(ratings_df, aes(x = total_cup_points)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  coord_cartesian(xlim = c(60, NA)) +
  theme_minimal() +
  labs(title = "Total Cup Points Distribution", x = "Total Cup Points", y = "Frequency")

ggplotly(points_dis)
```


Firstly, we accumulate the frequency of the total cup points. The distribution of total cup points is bell-shaped and similar to the normal distribution. The most frequent total cup points is 83, and most coffee beans are in the 80 to 85 cup points range.



#### Trend of Average Total Cup Points Over Years

```{r}
ratings_df |> 
  group_by(grading_year) |> 
  summarise(avg_total_cup_points = mean(total_cup_points, na.rm = TRUE)) |> 
  plot_ly(x = ~ grading_year, y = ~ avg_total_cup_points, type = "scatter", 
          mode = "lines + markers") |> 
  layout(title = "Trend of Average Total Cup Points Over Years",
         xaxis = list(title = "Year"),
         yaxis = list(title = "Average Total Cup Points"))
```


We examine trends over the 8-year time period to get insights into how coffee quality has fluctuated. The plot shows a non-linear trend of average cup points across eight years. The years 2010 and 2018 exhibited the highest average scores, while 2012 and 2017 saw significant dips. The variability in cup points across years indicates that coffee quality is not static and can fluctuate significantly, warranting a deeper investigation into contributing factors.


#### The Distribution of Varieties by Species


```{r}
variety_dis = ratings_df %>%
  filter(!is.na(variety)) %>%
  ggplot(aes(x = fct_rev(fct_infreq(variety)))) +
  geom_bar(fill = "skyblue") +
  facet_grid(~ species, scales = "free_x") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.5, size = 8),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Frequency of Varieties by Species",
    x = "Variety",
    y = "Count"
  )


ggplotly(variety_dis)
```


Then, we distribute the species and variety composition of the sample coffee beans. Almost all coffee beans belong to the Arabica species, and among the Arabica, Caturra, Bourbon, and Typica are the most abundant, while Sumatra Lintong, Sulawesi, Pache Comun, and Moka Peaberry are the least.  


#### Distribution of Total Cup Points by Species

```{r}
Q1 <- quantile(ratings_df$total_cup_points, 0.25)
Q3 <- quantile(ratings_df$total_cup_points, 0.75)
IQR <- Q3 - Q1
ratings_df <- ratings_df %>%
  filter(total_cup_points > (Q1 - 1.5 * IQR) & total_cup_points < (Q3 + 1.5 * IQR))

ratings_df |> 
  filter(!is.na(total_cup_points)) |> 
  plot_ly(x = ~ species, y = ~ total_cup_points, type = "box", color = ~species) |> 
   layout(title = "Boxplot of Total Cup Points by Species",
         xaxis = list(title = "Species"),
         yaxis = list(title = "Total Cup Points"))
```

We removed outliers by using the interquartile range (IQR) method to identify and filter extreme values. After removing outliers, the boxplot shows a more compact and representative distribution for both Arabica and Robusta species. The general trends remain the same, with Arabica having a slightly higher median and a wider data range than Robusta.


#### The Boxplot of Variety and Total Cup Points


```{r}
ratings_no_outliers |> 
  mutate(variety = fct_reorder(variety, total_cup_points)) |> 
  plot_ly(
    y = ~total_cup_points, 
    color = ~variety, 
    type = "box", 
    colors = "viridis"
  ) %>%
  layout(
    yaxis = list(
      title = "Total Cup Points",
      range = c(50, NA) 
    ),
    xaxis = list(
      title = "Variety"
    ))
```


We also produce the boxplot of total cup points by varieties. Through this boxplot, we know that Sumatra Lintong and Sumatra tend to perform better than the others on the total cup points, while Pache Comun and Java perform the worst. It is worth mentioning that the IQR of the total cup points of Java is the largest, which means the total cup points of Java have high variability and are more spread out around the median.


#### Proportion of Processing Methods

```{r}
ratings_df |> 
  count(processing_method) |> 
  mutate(prop = n / sum(n)) |> 
  plot_ly(
    x = ~ prop,
    y = ~ reorder(processing_method, prop),
    type = "bar",
    marker = list(fill = ~ processing_method)
  ) |> 
  layout(
    title = "Proportion of Processing Methods",
    xaxis = list(title = "Proportion"),
    yaxis = list(title = "Processing Method")
  )
```

Washed/Wet processing dominates (around 60%), followed by Natural/Dry methods. Other processing methods such as Semi-washed, Pulped Natural/Honey are less common. This highlights the dominance of Washed/Wet processing methods. However, alternative methods like Natural/Dry still hold a significant share, prompting further investigation into how processing affects scores.

#### Total Cup Points by Processing Methods

```{r}
without_outliers = ratings_df |> 
  drop_na(total_cup_points, processing_method)  |> 
  group_by(processing_method)  |> 
  mutate(
    Q1 = quantile(total_cup_points, 0.25),
    Q3 = quantile(total_cup_points, 0.75),
    IQR = Q3 - Q1,
    lower_bound = Q1 - 1.5 * IQR,
    upper_bound = Q3 + 1.5 * IQR
  )  |> 
  filter(total_cup_points >= lower_bound & total_cup_points <= upper_bound)

without_outliers |> 
  plot_ly(
    x = ~ total_cup_points,
    y = ~ reorder(processing_method, total_cup_points, median),
    type = "box",
    color = ~ processing_method
  )  |> 
  layout(
    title = "Total Cup Points by Processing Methods",
    xaxis = list(title = "Total Cup Points"),
    yaxis = list(title = "Processing Method")
  )
```

This comparison evaluates how different processing methods impact total cup points. The Natural/Dry processing method tends to yield the highest median and total cup points, suggesting its potential for producing higher-quality coffee. The Pulped Natural/Honey and Semi-washed/Semi-pulped methods have narrower distributions, indicating less variability in cup points. The Washed/Wet method is also consistent, with a median similar to Semi-washed but a slightly broader spread. 



#### The Distribution between Total Cup Points and Altitude by Variety



```{r}
altitude_model = lm(altitude_mean_meters ~ total_cup_points, data = ratings_no_outliers)

x_vals = seq(min(ratings_no_outliers$total_cup_points, na.rm = TRUE), 
              max(ratings_no_outliers$total_cup_points, na.rm = TRUE), length.out = 100)
y_preds = predict(altitude_model, newdata = data.frame(total_cup_points = x_vals))
```



```{r, warning=FALSE, message=FALSE}
ratings_no_outliers |>
  filter(!is.na(total_cup_points) & !is.na(altitude_mean_meters)) |>
  mutate(text_label = str_c("Total Cup Points: ", total_cup_points, 
                       "\nMean Altitude(meters): ", altitude_mean_meters,
                       "\nVariety: ", variety)) |>
  plot_ly(x = ~total_cup_points,
  y = ~altitude_mean_meters,
  type = "scatter",
  mode = "markers",
  color = ~variety,
  text = ~text_label,
  alpha = 0.5
) %>%
  add_lines(
    x = x_vals,
    y = y_preds,
    line = list(color = 'red'),
    name = 'Trend Line',
    showlegend = FALSE,
    inherit = FALSE
  ) %>%
  layout(
    title = "Total Cup Points vs. Mean Altitude (meters)",
    xaxis = list(title = "Total Cup Points",
      range = c(60, max(ratings_no_outliers$total_cup_points, na.rm = TRUE))),
    yaxis = list(title = "Altitude Mean Meters")
  )

```



This plot shows the distribution between the mean altitude of the coffee beans and the total cup points. Although there is no obvious trend if we only look at the scatter on the plot, we can see that there is a positive correlation between mean altitude and total cup points by looking at the increasing trend lines. As the altitude goes up, the total cup points of the coffee bean increases.





#### Origins of Top Coffees Each Year

```{r}
top_origins_yearly = 
  ratings_df |> 
  drop_na(variety) |> 
  group_by(grading_year) |> 
  arrange(grading_year, desc(total_cup_points)) |> 
  slice(1)

top_origins_yearly |> 
  arrange(grading_year) |> 
  select(grading_year, country_of_origin, total_cup_points, species, variety) |> 
  knitr::kable(
    col.names = c("Year", "Country of Origin", "Total Cup Points", 
                  "Species", "Variety"),
    caption = "Top Coffee by Country from 2010 to 2018",
  )
```

We are curious about the top coffee origins and want to see if there exists regional strengths or cultivation efforts. Therefore we make a table showing that top-performing coffees come from a diverse set of countries, with no single country dominating year after year. Ethiopia appears twice, with exceptionally high scores in 2015. 

## Survey Data

```{r}
survey_tidy = 
  survey %>% 
  rename_with(
    ~ sub("personal_preference", "preference", .),
    .cols = ends_with("personal_preference")
  ) %>% 
  pivot_longer(
    cols = coffee_a_bitterness:coffee_d_preference,
    values_to = "score",
    names_to = c("coffee_name", "coffee_feature"),
    names_pattern = "(.*)_(.*)"
  ) %>% 
  pivot_wider(
    names_from = coffee_feature,
    values_from = score
  ) %>% 
  mutate(
    coffee_name = case_match(coffee_name,
                             "coffee_a" ~ "Coffee A",
                             "coffee_b" ~ "Coffee B",
                             "coffee_c" ~ "Coffee C",
                             "coffee_d" ~ "Coffee D"),
    coffee_name = as.factor(coffee_name)
  ) %>% 
  mutate(
    age = factor(age, levels = rev(c("<18 years old", "18-24 years old", "25-34 years old", 
                                "35-44 years old", "45-54 years old", "55-64 years old", 
                                ">65 years old"))),
    cups = factor(cups, levels = rev(c("More than 4", "4", "3", "2", "1", "Less than 1"))),
    education_level = factor(education_level, 
                             levels = c("Doctorate or professional degree", "Master's degree",
                                        "Bachelor's degree", "Some college or associate's degree",
                                        "High school graduate", "Less than high school")),
    favorite = fct_recode(favorite, "Blended drink" = "Blended drink (e.g. Frappuccino)"),
    most_paid = factor(most_paid, levels = c("Less than $2", "$2-$4", "$4-$6", "$6-$8", 
                                             "$8-$10", "$10-$15", "$15-$20", "More than $20")),
    most_willing = factor(most_willing, levels = c("Less than $2", "$2-$4", "$4-$6", "$6-$8", 
                                             "$8-$10", "$10-$15", "$15-$20", "More than $20")),
    total_spend = factor(total_spend, levels = c("<$20", "$20-$40", "$40-$60", "$60-$80", "$80-$100",
                                                 ">$100")),
    caffeine = factor(caffeine, levels = c("Decaf", "Half caff", "Full caffeine"))
  ) %>% 
  relocate(prefer_overall, .after = everything())
```

### Distribution: Bar charts

```{r}
brew_df = 
  survey_tidy %>% 
  distinct(submission_id, brew) %>% 
  drop_na(brew) %>% 
  mutate(brew = str_split(brew, ", ")) %>% 
  unnest(brew) %>% 
  group_by(brew) %>% 
  count() %>% 
  ungroup() %>%
  mutate(brew = str_replace(brew, "\\(.*", ""))

brew_df %>% 
  mutate(brew = fct_reorder(brew, n),
         brew = fct_rev(brew)) %>% 
  plot_ly(x = ~brew, y = ~n,
          color = ~brew, name = ~brew, type = "bar", colors = "viridis") %>% 
  layout(title = "How Do You Brew Coffee at Home?",
         xaxis = list(title = "Methods"),
         yaxis = list(title = "Count"),
         showlegend = FALSE)

why_drink_df = 
  survey_tidy %>% 
  distinct(submission_id, why_drink) %>% 
  drop_na(why_drink) %>% 
  mutate(why_drink = str_split(why_drink, ", ")) %>% 
  unnest(why_drink) %>% 
  group_by(why_drink) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(why_drink = case_match(why_drink, 
                                "I need the caffeine" ~ "Caffeine",
                                "I need the ritual" ~ "Ritual",
                                "It makes me go to the bathroom" ~ "To poop",
                                "It tastes good" ~ "Tastes good",
                                "Other" ~ "Other"))

why_drink_df %>% 
  mutate(why_drink = fct_reorder(why_drink, n),
         why_drink = fct_rev(why_drink)) %>% 
  plot_ly(x = ~why_drink, y = ~n,
          color = ~why_drink, name = ~why_drink, type = "bar", colors = "viridis") %>% 
  layout(title = "Why Do You Drink Coffee?",
         xaxis = list(title = "Reasons"),
         yaxis = list(title = "Count"),
         showlegend = FALSE)
```

To start with, we built two bar charts to evaluate the distribution of the variables "brew" and "why_drink". The resulting graphs show that the most commonly used brewing method in the survey is "pour over", and people drink coffee mostly for it "tastes good".

### Co-occurence: Heatmaps

```{r}
survey_long =
  survey_tidy %>% 
  select(submission_id, where_drink) %>% 
  distinct(submission_id, .keep_all = TRUE) %>% 
  separate_rows(where_drink, sep = ", ") %>% 
  mutate(where_drink = str_trim(where_drink))

co_occurrence =
  survey_long %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = where_drink, values_from = value, values_fill = 0) %>%
  select(-submission_id) %>%
  as.matrix() %>%
  as("sparseMatrix")  # Convert to sparse matrix for efficient operations

co_matrix = t(co_occurrence) %*% co_occurrence  # Calculate the co-occurrence matrix

total_submission = 
  survey_tidy %>% 
  select(submission_id, where_drink) %>% 
  distinct(submission_id, .keep_all = TRUE) %>% 
  count() %>% 
  pull()

co_matrix_percent = (co_matrix / total_submission) * 100 

top_categories = 
  co_matrix %>% 
  rowSums() %>% 
  order(decreasing = TRUE)

co_matrix_dense_subset = 
  co_matrix_percent[top_categories, top_categories] %>% 
  as.matrix()

co_occurrence_df = 
  co_matrix_dense_subset %>% 
  reshape2::melt() %>% 
  rename(
    Category1 = Var1,
    Category2 = Var2,
    Percentage = value
  )

co_occurrence_df %>% 
  plot_ly(x = ~Category1, y = ~Category2, z = ~Percentage, 
          type = "heatmap", colors = "Spectral") %>% 
  add_annotations(
    text = ~round(Percentage, 2), 
    font = list(size = 14, color = "white"), 
    showarrow = FALSE) %>% 
  layout(
    title = "Co-occurrence Heatmap: Where Do You Drink Coffee?",
    xaxis = list(title = ""),
    yaxis = list(title = ""))
```

To investigate questions that can select multiple answers, we built this co-occurrence heatmap. Based on its results, we found that most people in this survey chose to drink coffee at home, while a proportion of people who choose to drink coffee at home also drink it in their office and in the cafe. 

## Correlation: Favorite coffee vs. education level

```{r}
survey_tidy |>
  mutate(favorite = fct_rev(fct_infreq(favorite))) |>
  distinct(submission_id, education_level, favorite) |>
  group_by(education_level, favorite) |>
  summarise(total_fav = n()) |>
  mutate(prop_edu = total_fav/sum(total_fav)) |>
  plot_ly(x = ~prop_edu * 100, y = ~education_level,
          color = ~favorite, name = ~favorite, type = "bar", colors = "viridis") |>
  layout(title = "Favorite Type of Coffee Across Education Level",
         xaxis = list(title = "Percentage (%)"),
         yaxis = list(title = "Education Level"),
         legend = list(orientation = "h", 
                       y = -0.3,
                       title = list(text = "<b>Favorite Type of Coffee</b>")),
         barmode = "stack")
```

This percentage bar plot reveals that, the more educated people are, the more they like pour-over coffee, and the less they like regular latte. 

## Correlation: Total money spend on coffee and education level

```{r}
survey_tidy %>% 
  drop_na(total_spend, education_level) %>% 
  distinct(submission_id, total_spend, education_level) %>% 
  group_by(total_spend, education_level) %>% 
  summarize(count = n()) %>% 
  ungroup() %>% 
  plot_ly(x = ~total_spend, y = ~count,
          color = ~education_level, name = ~education_level, 
          type = "scatter", mode = "lines", colors = "viridis") %>% 
  layout(title = "Total Spend on Coffee per month Across Education Level",
         xaxis = list(title = "Total Spend on Coffee (per month)"),
         yaxis = list(title = "Count"),
         legend = list(orientation = "h", 
                       y = -0.3,
                       title = list(text = "<b>Education Level</b>")))
```

From the line chart above, we can know that the higher a degree people possess, the more they spend on coffee per month. 

## Correlation: Most weilling to pay vs. most paid

```{r}
survey_tidy %>% 
  drop_na(most_paid, most_willing) %>% 
  distinct(submission_id, most_paid, most_willing) %>% 
  group_by(most_paid, most_willing) %>% 
  summarize(count = n()) %>% 
  ungroup() %>% 
  plot_ly(x = ~most_paid, y = ~most_willing, z = ~count, 
          type = "heatmap", colors = "viridis") %>% 
  add_annotations(
    text = ~count, 
    font = list(size = 14, color = "white"), 
    showarrow = FALSE) %>% 
  layout(
    title = "Most Willing to Pay vs. Most Paid (per cup)",
    xaxis = list(title = "Most Paid (per cup)"),
    yaxis = list(title = "Most Willing to Pay (per cup)"))
```

This heatmap shows that, although most people pay what they say they would pay for coffee, some people would pay a lot more than what they are actually paying for a cup of coffee, suggesting potential space of improvement for current coffee market. 

## Coffee ratings: Expertise vs. Preference

```{r}
survey_tidy %>% 
  distinct(submission_id, prefer_overall, expertise) %>% 
  group_by(expertise, prefer_overall) %>% 
  summarize(total_exp = n()) %>%
  mutate(prop = total_exp / sum(total_exp)) %>% 
  plot_ly(x = ~expertise, y = ~(prop * 100),
          color = ~prefer_overall, name = ~prefer_overall, 
          type = "bar", colors = "viridis") %>% 
  layout(title = "Overall Preference Across Self-rated Expertise",
         xaxis = list(title = "Self-rated Coffee Expertise"),
         yaxis = list(title = "Percentage (%)"),
         legend = list(orientation = "h", 
                       y = -0.3,
                       title = list(text = "<b>Overall Preference</b>"),
                       traceorder = "normal"),
         barmode = "stack")
```

This percentage bar chart tells us that, the distribution of overall coffee pick is mostly even for people who do not consider themselves as coffee experts, while for those who consider themselves to be experts, coffee A and coffee D are the most popular, a very interesting trend that we will investigate further.

## Distributions of Coffee ratings

```{r}
survey_tidy %>% 
  select(submission_id, coffee_name, preference) %>% 
  group_by(coffee_name, preference) %>% 
  drop_na(preference) %>% 
  count() %>% 
  ggplot(aes(x = preference, y = n, fill = coffee_name)) +
  geom_col(width = 1, alpha = 0.8, color = "white") +
  geom_line(aes(group = 1), color = "black", size = 1, alpha = 0.8) +
  facet_grid(. ~ coffee_name) +
  labs(
    title = "How Do You Rate Each Coffee",
    x = "Preference Ratings",
    y = "Count",
    fill = "Coffee Name")
```

Moreover, the distributions of respective coffee ratings reveal that, people either like coffee D very much or do not like it at all, suggesting there must be something special about this coffee.

## Distributions of Flavor and Coffee type

```{r}
plot_acidity = 
  survey_tidy %>% 
  select(coffee_name, acidity) %>% 
  group_by(coffee_name) %>% 
  plot_ly(y = ~acidity, 
          color = ~coffee_name, 
          type = "box", 
          colors = "viridis",
          showlegend = FALSE)

plot_bitterness = 
  survey_tidy %>% 
  select(coffee_name, bitterness) %>% 
  group_by(coffee_name) %>% 
  plot_ly(y = ~bitterness, 
          color = ~coffee_name, 
          type = "box", 
          colors = "viridis",
          showlegend = FALSE)

subplot(plot_acidity, plot_bitterness, nrows = 2, margin = 0.07) %>% 
  layout(annotations = list(
    list(
      x = 0.5,  
      y = 1.0,  
      text = "Distribution of Acidity Ratings",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE
    ),
    list(
      x = 0.5,  
      y = 0.45,  
      text = "Distribution of Bitterness Ratings",  
      xref = "paper",  
      yref = "paper",  
      xanchor = "center",  
      yanchor = "bottom",  
      showarrow = FALSE
    )
  ))
```

The boxplots imply the first potential difference between coffee A&D and coffee B&C: coffee A&D are more acidic while less bitter. 

Therefore, we will continue to discover whether this difference is statistically significant, and what characteristics may influence people's choice on coffee A or D, while they are similar in some flavors. Also, since expertise is a self-rated measure here, we will also examine what factors are correlated with how people rate themselves to be coffee experts.  

## Statistical Analysis

### Ratings Data

#### Correlation Test


```{r}
features <- c("aroma", "flavor", "aftertaste", "acidity", "body", "balance", "sweetness")
target <- "total_cup_points"
```

We choose the variables associated with the sensory, which are `aroma`, `flavor`, `aftertaste`, `acidity`, `body`, `balance`, and `sweetness`, as the predictor variables of the model, and the `total_cup_points` as the response variable.

```{r}
corr_matrix = cor(ratings_df[, c(features, target)], use = "complete.obs")
corrplot(corr_matrix, method = "number", type = "upper", tl.cex = 0.8)
```

To check the effectiveness of the variables, if these variables affect the total cup points, we perform the correlation test between these variables before building the model. A larger coefficient indicates a stronger correlation. There are high correlations between almost all independent variables and the dependent variable. Although the correlation between `sweetness` and `total_cup_points` is the lowest, the correlation is not weak, so we will use all these predictors to build the model. Since there are so many predictors, we will choose to make a lasso model.

#### Lasso Model

```{r}
x = as.matrix(ratings_df[, features])
y = ratings_df |> pull(total_cup_points)
```



```{r}
lambda = 10^(seq(-2, 2.75, 0.1))

lasso_fit =
  glmnet(x, y, lambda = lambda)

lasso_cv =
  cv.glmnet(x, y, lambda = lambda)

lambda_opt = lasso_cv[["lambda.min"]]
```

Generating a sequence of lambda values to create a range of lambda values on a logarithmic scale to ensure our proper exploration of the regularization strength.




```{r}
lasso_cv |> 
  broom::tidy() |> 
  ggplot(aes(x = log(lambda, 10), y = estimate)) + 
  geom_point()
```

This plot visualizes the effect of different lambda values on the estimated coefficients.

At smaller values of log(lambda, 10), the estimated coefficients are smaller or close to zero.As log(lambda, 10) increases, the coefficients stabilize and converge toward specific values.

```{r}
lasso_fit = glmnet(x, y, lambda = lambda_opt)

lasso_fit |> broom::tidy() |> 
  knitr::kable()
```

The intercept value is 5.08, which represents the baseline predicted value of `total_cup_points` when all predictors are zero.

All predictors (`aroma`, `flavor`, `aftertaste`, `acidity`, `body`, `balance`, `sweetness`) have non-zero coefficients, indicating they contribute to the model at the optimal lambda.

`flavor` has the largest coefficient with the value of 1.97, suggesting that flavor is the most influential predictor in determining the total cup points.

`body`(0.579) and `acidity`(0.895) have relatively the smallest coefficients, indicating that they have a weaker influence on the total cup points compared to others variables.

The deviance ratio is 0.923, suggesting that the model explains a significant portion of the variability in `total_cup_points.`

#### ANOVA

```{r}
ratings_no_outliers = ratings_df |>
  drop_na(processing_method)

anova_method = aov(total_cup_points ~ processing_method, data = ratings_no_outliers)
summary(anova_method)
```


The results of the one-way ANOVA test, as displayed in the output, assess whether there is a significant difference in total cup points among different processing methods in the dataset. The F-statistic value is 1.978 with a p-value of 0.0956. Since the p-value is greater than the typical significance level of 0.05, we fail to reject the null hypothesis. This suggests that there is no statistically significant difference in the total cup points across the processing methods at the 5% significance level. 

#### T Test


```{r}
pairwise.t.test(ratings_no_outliers$total_cup_points, ratings_no_outliers$processing_method, 
                                    p.adjust.method = "bonferroni")
```

The results of the pairwise t-tests, adjusted using the Bonferroni method for multiple comparisons, reveal no statistically significant differences in total cup points between any pairs of processing methods. All adjusted p-values are greater than 0.05. This suggests that the mean total cup points are comparable across the different processing methods analyzed (e.g., Natural/Dry, Other, Pulped Natural/Honey, Semi-Washed/Semi-Pulped, and Washed/Wet). The lack of significant differences aligns with the earlier ANOVA results, indicating that the processing method does not have a substantial impact on total cup points when considering the current dataset.

## Survey Data

### ANOVA test: biterness, acidity, preference

```{r}
survey_anova = survey_tidy |>
  select(coffee_name, bitterness, acidity, preference) |>
  na.omit() |>
  slice_sample(n = 1000)

anova_bitterness = aov(bitterness ~ coffee_name, data = survey_anova)

summary(anova_bitterness)

pairwise_bitterness = pairwise.t.test(survey_anova$bitterness, survey_anova$coffee_name, 
                                    p.adjust.method = "bonferroni")

print(pairwise_bitterness)

survey_anova |>
  group_by(coffee_name) |>
  summarise(
    mean_bitterness = mean(bitterness)) |>
  knitr::kable(digits = 3)

anova_acidity = aov(acidity ~ coffee_name, data = survey_anova)

summary(anova_acidity)

pairwise_acidity = pairwise.t.test(survey_anova$acidity, survey_anova$coffee_name, 
                                    p.adjust.method = "bonferroni")

print(pairwise_acidity)

survey_anova |>
  group_by(coffee_name) |>
  summarise(
    mean_acidity = mean(acidity)) |>
  knitr::kable(digits = 3)

anova_preference = aov(preference ~ coffee_name, data = survey_anova)

summary(anova_preference)

pairwise_preference = pairwise.t.test(survey_anova$preference, survey_anova$coffee_name, 
                                    p.adjust.method = "bonferroni")

print(pairwise_preference)

survey_anova |>
  group_by(coffee_name) |>
  summarise(
    mean_preference = mean(preference)) |>
  knitr::kable(digits = 3)
```

The results of these 3 ANOVA tests and the following pairwise t-tests statistically support the distributions of the boxplots. That is, coffee A&D are significantly more acidic than coffee B&C, and coffee B&C are significantly more bitter than coffee A&D. What's more, the tests on people's overall preference tell that people also score coffee A&D significantly higher than coffee B&C.

### Coffee A or D?

```{r}
coffee_ad_df = 
  survey_tidy %>% 
  distinct(submission_id, prefer_ad, gender, age, expertise, style, strength, caffeine) %>%
  drop_na(gender, age, expertise, style, strength, caffeine) %>%
  filter(
    gender %in% c("Male", "Female", "Non-binary"),
    age != "<18 years old"
  ) %>% 
  mutate(prefer_ad = if_else(prefer_ad == "Coffee D", 1, 0))

bootstraps_ad = 
  coffee_ad_df %>% 
  bootstrap(100) %>% 
  mutate(
    strap = map(strap, as_tibble),
    models = map(strap, \(df) glm(prefer_ad ~ gender + age + expertise + style + 
                                    strength + caffeine, data = df, family = "binomial")),
    results = map(models, broom::tidy)
  ) %>% 
  select(.id, results) %>% 
  unnest(results)

ad_results = 
  bootstraps_ad %>% 
  group_by(term) %>% 
  summarize(
    boot_mean = mean(estimate),
    boot_se = sd(estimate)
  ) 

ad_results %>% 
  knitr::kable(digits = 3)

bootstraps_ad %>% 
  mutate(term = fct_reorder(term, estimate)) %>% 
  group_by(term) %>% 
  plot_ly(x = ~estimate, 
          color = ~term, 
          type = "box", 
          colors = "viridis",
          showlegend = FALSE) %>% 
  layout(title = "Distribution of terms",
         xaxis = list(title = "Estimate"),
         yaxis = list(title = "Term"))
```

While people who rated themselves as coffee experts like both coffee A and coffee D, what may differentiate them from choosing between these 2 coffees? From this logistic regression model, we found that people who like fruity coffee and were younger when taken the survey were more likely to choose coffee D over coffee A. This corresponds with the survey design that coffee D is a more innovative and fruity-mixed coffee. 

## What makes people think they are experts?

```{r}
full_mlr = lm(expertise ~ age + favorite + style + strength + roast_level +
       caffeine + gender + education_level, data = survey_model)

step(full_mlr, direction = "backward")

final_mlr = lm(expertise ~ age + style + strength + roast_level + 
    caffeine + gender, data = survey_model)

final_mlr |>
  broom::tidy() |>
  knitr::kable(digits = 3)
```

The multiple linear regression model filters style_bright, style_fruity, style_juicy, strong to somewhat strong strength, light and Nordic roast level, half-caffeine and full-caffeine, and gender_male as significant predictors of whether people consider themselves to be coffee experts. There are interesting overlaps with the previous logistic regression model, as people who like fruity and juicy styled coffee are also more likely to choose coffee D. 

## Discussion

The trend in average total cup points across eight years reveals significant fluctuations in coffee quality, with notable peaks in 2010 and 2018 reflecting higher overall quality and dips in years such as 2012 and 2017. Most total cup points fall within the 80 to 85 range, and the majority of the sample coffee beans are Arabica, which consistently achieves a higher median and narrower interquartile range compared to Robusta. This aligns with Arabica’s reputation as a higher-quality species, whereas Robusta exhibits greater variability, possibly due to diverse cultivation practices and market applications. Additionally, there is a positive correlation between mean altitude and total cup points, with higher altitudes corresponding to higher-quality coffee beans, further highlighting the impact of environmental factors on quality. Processing methods emphasize the dominance of Washed/Wet processing, which accounts for 60% of the dataset, reflecting its widespread industry adoption, while Natural/Dry processing stands out with the highest median cup points, suggesting its potential for producing high-quality coffee and indicating regional or market-specific preferences. Lastly, coffee origins underscore the global nature of high-quality production, with Ethiopia’s prominence illustrating the influence of regional factors and its established reputation in the specialty coffee market, emphasizing the importance of local growing conditions, geographic diversity, and altitude.



Our predictive modeling using regression analysis highlights flavor as the most influential factor driving total cup points, followed by aftertaste and balance, emphasizing the importance of these sensory attributes in defining coffee quality and consumer preferences. While body and acidity have relatively smaller coefficients, they remain integral components of coffee evaluation. After conducting statistical testing through ANOVA and t-tests, there is no statistically significant differences in total cup points across processing methods, indicating that the method of processing alone does not substantially affect coffee quality.




## Limitations

* Since Arabica coffee account for a large proportion of species in our dataset, we cannot tell the objective difference in coffee performance between the two coffee species. The data for a species with a uniform distribution will provide more information for the relevant analysis.

* The ratings data spans eight years, but it does not account for external variables like climate changes, global market dynamics, or agricultural practices that could influence coffee quality. These factors could have contributed to the observed fluctuations but were not explicitly analyzed.

* The survey is only toward American citizens, so we do not know about people's opinions on coffee from different countries. As culture differs, people's preferences on coffee may also differ. This is one very interesting point that we cannot cover in our project but worth further discovering. 

* The survey only asks two flavors for each coffee -- acidity and bitterness, but the professional rating scale has more factors like balance and aftertaste. Can people who are not coffee professionals also taste such differences and be influenced on how they choose their favorite coffee? Future surveys can include more options on the flavor of different coffees. 





