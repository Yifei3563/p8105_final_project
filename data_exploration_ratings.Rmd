---
title: "Data Exploration"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide

---
```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(modelr)
library(haven)
library(dplyr)
library(plotly)
library(readr)
library(forcats)
library(corrplot)
library(glmnet)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%",
  warning = FALSE,
  message = FALSE
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


```{r}
ratings_df = read_csv("data/coffee_ratings.csv") %>% 
  janitor::clean_names() %>%
  select(total_cup_points, species, country_of_origin, 
         region, number_of_bags, bag_weight, grading_date, variety,
         processing_method, aroma, flavor, aftertaste, acidity, body, balance,
         uniformity, clean_cup, sweetness, cupper_points, moisture, color,
         altitude_low_meters, altitude_high_meters, altitude_mean_meters) %>%
  mutate(grading_year = str_extract(grading_date, "\\d{4}"),
         species = as.factor(species),
         variety = as.factor(variety),
         processing_method = as.factor(processing_method),
         moisture = as.factor(moisture),
         color = as.factor(color))
```


```{r}
Q1_tcup = quantile(ratings_filtered$total_cup_points, 0.25, na.rm = TRUE)
Q3_tcup = quantile(ratings_filtered$total_cup_points, 0.75, na.rm = TRUE)
IQR_tcup = Q3_tcup - Q1_tcup

lower_bound_tcup = Q1_tcup - 1.5 * IQR_tcup
upper_bound_tcup = Q3_tcup + 1.5 * IQR_tcup

Q1_alt = quantile(ratings_filtered$altitude_mean_meters, 0.25, na.rm = TRUE)
Q3_alt = quantile(ratings_filtered$altitude_mean_meters, 0.75, na.rm = TRUE)
IQR_alt = Q3_alt - Q1_alt

lower_bound_alt = Q1_alt - 1.5 * IQR_alt
upper_bound_alt = Q3_alt + 1.5 * IQR_alt

ratings_no_outliers = ratings_df %>%
  filter(
    total_cup_points >= lower_bound_tcup & total_cup_points <= upper_bound_tcup,
    altitude_mean_meters >= lower_bound_alt & altitude_mean_meters <= upper_bound_alt
  )
```


### The Distribution of the Total Cup Points

```{r}
points_dis = ggplot(ratings_df, aes(x = total_cup_points)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  coord_cartesian(xlim = c(60, NA)) +
  theme_minimal() +
  labs(title = "Total Cup Points Distribution", x = "Total Cup Points", y = "Frequency")

ggplotly(points_dis)
```


### Trend of Average Total Cup Points Over Years

```{r}
ratings_df |> 
  group_by(grading_year) |> 
  summarise(avg_total_cup_points = mean(total_cup_points, na.rm = TRUE)) |> 
  plot_ly(x = ~ grading_year, y = ~ avg_total_cup_points, type = "scatter", 
          mode = "lines + markers") |> 
  layout(title = "Trend of Average Total Cup Points Over Years",
         xaxis = list(title = "Year"),
         yaxis = list(title = "Average Total Cup Points"))
```

Overall, the graph shows a non-linear trend in the average total cup points over the 8 years, with notable dips in 2012 and 2017. The years 2010 and 2018 exhibit the highest average total cup points.

### The Distribution of Variety by Species


```{r}
variety_dis = ratings_df %>%
  filter(!is.na(variety)) %>%
  ggplot(aes(x = fct_rev(fct_infreq(variety)))) +
  geom_bar(fill = "skyblue") +
  facet_grid(~ species, scales = "free_x") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.5, size = 8),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Frequency of Varieties by Species",
    x = "Variety",
    y = "Count"
  )


ggplotly(variety_dis)
```


### The Boxplot of Variety and Total Cup Points (drop outliers)


```{r}
ratings_df |> 
  mutate(variety = fct_reorder(variety, total_cup_points)) |> 
  plot_ly(
    y = ~total_cup_points, 
    color = ~variety, 
    type = "box", 
    colors = "viridis"
  ) %>%
  layout(
    yaxis = list(
      title = "Total Cup Points",
      range = c(60, NA) 
    ),
    xaxis = list(
      title = "Variety"
    ))
```


### Distribution of Total Cup Points by Species

```{r}
Q1 <- quantile(ratings_df$total_cup_points, 0.25)
Q3 <- quantile(ratings_df$total_cup_points, 0.75)
IQR <- Q3 - Q1
ratings_df <- ratings_df %>%
  filter(total_cup_points > (Q1 - 1.5 * IQR) & total_cup_points < (Q3 + 1.5 * IQR))

ratings_df |> 
  filter(!is.na(total_cup_points)) |> 
  plot_ly(x = ~ species, y = ~ total_cup_points, type = "box", color = ~species) |> 
   layout(title = "Boxplot of Total Cup Points by Species",
         xaxis = list(title = "Species"),
         yaxis = list(title = "Total Cup Points"))
```

We removed outliers by using the interquartile range (IQR) method to identify and filter extreme values. After removing outliers, the boxplot shows a more compact and representative distribution for both Arabica and Robusta species. The general trends remain the same, with Arabica having a slightly higher median and a wider data range than Robusta.

### Proportion of Processing Methods

```{r}
ratings_df |> 
  count(processing_method) |> 
  mutate(prop = n / sum(n)) |> 
  plot_ly(
    x = ~ prop,
    y = ~ reorder(processing_method, prop),
    type = "bar",
    marker = list(fill = ~ processing_method)
  ) |> 
  layout(
    title = "Proportion of Processing Methods",
    xaxis = list(title = "Proportion"),
    yaxis = list(title = "Processing Method")
  )
```

In our dataset, Washed/Wet processing method dominates the distribution, accounting for about 60%. Natural/Dry processing also has a notable share, while other methods, including Semi-washed, Other, and Pulped Natural/Honey, are much less commonly used.  

### Total Cup Points by Processing Methods

```{r}
without_outliers = ratings_df |> 
  drop_na(total_cup_points, processing_method)  |> 
  group_by(processing_method)  |> 
  mutate(
    Q1 = quantile(total_cup_points, 0.25),
    Q3 = quantile(total_cup_points, 0.75),
    IQR = Q3 - Q1,
    lower_bound = Q1 - 1.5 * IQR,
    upper_bound = Q3 + 1.5 * IQR
  )  |> 
  filter(total_cup_points >= lower_bound & total_cup_points <= upper_bound)

without_outliers |> 
  plot_ly(
    x = ~ total_cup_points,
    y = ~ reorder(processing_method, total_cup_points, median),
    type = "box",
    color = ~ processing_method
  )  |> 
  layout(
    title = "Total Cup Points by Processing Methods",
    xaxis = list(title = "Total Cup Points"),
    yaxis = list(title = "Processing Method")
  )
```

The Natural/Dry processing method tends to yield the highest median and total cup points, suggesting its potential for producing higher-quality coffee. The Pulped Natural/Honey and Semi-washed/Semi-pulped methods have narrower distributions, indicating less variability in cup points. The Washed/Wet method is also consistent, with a median similar to Semi-washed but a slightly broader spread. Therefore, the differences in quality (as measured by total cup points) is associated with various processing methods, with Natural/Dry generally performing better scores.

### The Distribution between Total Cup Points and Altitude by Variety （drop outliers）

```{r}
ratings_filtered <- ratings_df %>%
  filter(!is.na(total_cup_points) & !is.na(altitude_mean_meters))

top_n_varieties = 8

top_varieties <- ratings_filtered %>%
  count(variety, sort = TRUE) %>%
  top_n(top_n_varieties, n) %>%
  pull(variety)

ratings_filtered <- ratings_filtered %>%
  mutate(
    variety = ifelse(variety %in% top_varieties, as.character(variety), "Other"),
    variety = as.factor(variety),  
    text_label = str_c("Total Cup Points: ", total_cup_points, 
                       "\nMean Altitude(meters): ", altitude_mean_meters,
                       "\nVariety: ", variety)
  )

```


```{r}
plot_ly(
  data = ratings_filtered,
  x = ~total_cup_points,
  y = ~altitude_mean_meters,
  type = "scatter",
  mode = "markers",
  color = ~variety,
  text = ~text_label,
  alpha = 0.5
) %>%
  layout(
    title = "Total Cup Points vs. Mean Altitude (meters)",
    xaxis = list(title = "Total Cup Points",
      range = c(60, max(ratings_filtered$total_cup_points, na.rm = TRUE))),
    yaxis = list(title = "Altitude Mean Meters")
  )
```


### The Origins of Top Coffees Each Year from 2010 to 2018

```{r}
top_origins_yearly = 
  ratings_df |> 
  group_by(grading_year) |> 
  arrange(grading_year, desc(total_cup_points)) |> 
  slice(1)

top_origins_yearly |> 
  arrange(grading_year) |> 
  select(grading_year, country_of_origin, total_cup_points, species, variety) |> 
  knitr::kable(
    col.names = c("Year", "Country of Origin", "Total Cup Points", 
                  "Species", "Variety"),
    caption = "Top Coffee by Country from 2010 to 2018",
  )
```

The diversity of countries shows that competition in the coffee industry is global, with no single country dominating year after year. 

Brazil has been on the list twice (2011 and 2013), indicating that it has consistently produced highly rated coffee during this period. 

Ethiopia showed pretty good coffee strength with a top score of 90.58 in 2015, which is the highest coffee rating in those eight years.
